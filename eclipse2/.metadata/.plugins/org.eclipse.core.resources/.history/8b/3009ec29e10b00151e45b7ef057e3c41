package com.superzanti.serversync;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.ArrayList;

public class SyncServerConnection implements Runnable {
	
	private static Socket clientsocket;
	private static ObjectInputStream ois;
	private static ObjectOutputStream oos;
    private static ArrayList<String> allList = new ArrayList<String>();
    private static ServerSocket server;
	
	protected SyncServerConnection(Socket socket, ArrayList<String> allFiles, ServerSocket theServer){
		clientsocket = socket;
		allList.clear();
		allList.addAll(allFiles);
		server = theServer;
		ServerSyncRegistry.logger.info("Connection established with " + clientsocket);
		return;
	}

	@Override
	public void run() {
		try
		{
			ois = new ObjectInputStream(clientsocket.getInputStream());
			oos = new ObjectOutputStream(clientsocket.getOutputStream());
			oos.flush();
			while(true) {
				String message = (String) ois.readObject();
				ServerSyncRegistry.logger.info("Received message: "+message+" from connection "+clientsocket);
		
				if(message.equals(ServerSyncRegistry.SECURE_RECURSIVE)) {
					oos.writeObject(allList);
					oos.flush();
				}
				
				if(message.equals(ServerSyncRegistry.SECURE_CHECKSUM)) {
					String theFile = (String) ois.readObject();
					File f = new File(theFile);
					String serverChecksum = Md5.md5String(f);
					oos.writeObject(serverChecksum);
					oos.flush();
				}
				
				if(message.equals(ServerSyncRegistry.SECURE_UPDATE)) {
					ServerSyncRegistry.logger.info("Writing file to client...");
					String theFile = (String) ois.readObject();
					File f = new File(theFile);
					byte[] buff = new byte[clientsocket.getSendBufferSize()];
					int bytesRead = 0;
					InputStream in = new FileInputStream(f);
					while((bytesRead = in.read(buff))>0) {
						oos.write(buff,0,bytesRead);
					}
					in.close();
					break;
				}
				
				if(message.equals(ServerSyncRegistry.SECURE_EXISTS)) {
					String theFile = (String) ois.readObject();
					File f = new File(theFile);
					if(f.exists() && !f.isDirectory()) {
						oos.writeObject("true");
					}
					else {
						oos.writeObject("false");
					}
				}
				
				if(message.equals(ServerSyncRegistry.SECURE_EXIT)) {
					break;
				}
			}
			ServerSyncRegistry.logger.info("Connection "+clientsocket+" is closing.");
		}
		catch(Exception e)
		{
			ServerSyncRegistry.logger.info("Error occured: "+e);
		} finally {
			try {
				ois.close();
				oos.close();
				Thread.sleep(10);
				clientsocket.close();
			} catch (IOException e) {
				ServerSyncRegistry.logger.info("Error occured: "+e);
			} catch (InterruptedException e) {
				ServerSyncRegistry.logger.info("Error occured: "+e);
			}
		}
		return;
	}
	
	private static void reinitConn() throws Exception {
		oos.close();
		ois.close();
		clientsocket.close();
		Thread.sleep(10);
		clientsocket = server.accept();
		oos = new ObjectOutputStream(clientsocket.getOutputStream());
		ois = new ObjectInputStream(clientsocket.getInputStream());
		return;
	}

}
